<% layout('layouts/boilerplate') -%>
<link rel="stylesheet" href="/stylesheets/starability.css" />

<div class="row">
  <div class="col-sm-3">here goes the graph</div>
  <div class="col-sm-6">
    <h4 class="mb-4">
      <a href="/campgrounds/<%=campgroundID%>"><%=title%></a>
    </h4>

    <%if(currentUser){%> <%if(userReview === undefined){%>
    <!-- person is logged in, index is -1 and hence userReview is still undefined, perosn has not made a review  -->
    <hr class="my-1" />
    <div class="mb-4">
      <h5>Leave a Review</h5>
      <form
        method="post"
        action="/campgrounds/<%=campgroundID%>/reviews"
        class="mb-3 needs-validation"
        novalidate
      >
        <div>
          <fieldset class="starability-basic">
            <input
              type="radio"
              id="no-rate"
              class="input-no-rate"
              name="review[rating]"
              value="1"
              checked
              aria-label="No rating."
            />
            <input
              type="radio"
              id="first-rate1"
              name="review[rating]"
              value="1"
            />
            <label for="first-rate1" title="Terrible">1 star</label>
            <input
              type="radio"
              id="first-rate2"
              name="review[rating]"
              value="2"
            />
            <label for="first-rate2" title="Not good">2 stars</label>
            <input
              type="radio"
              id="first-rate3"
              name="review[rating]"
              value="3"
            />
            <label for="first-rate3" title="Average">3 stars</label>
            <input
              type="radio"
              id="first-rate4"
              name="review[rating]"
              value="4"
            />
            <label for="first-rate4" title="Very good">4 stars</label>
            <input
              type="radio"
              id="first-rate5"
              name="review[rating]"
              value="5"
            />
            <label for="first-rate5" title="Amazing">5 stars</label>
          </fieldset>
        </div>
        <div class="mb-3">
          <label for="body" class="form-label">Review Text</label>
          <textarea
            class="form-control"
            name="review[body]"
            id="body"
            rows="3"
            required
          ></textarea>
          <div class="valid-feedback">Looks good!</div>
        </div>
        <button class="btn btn-success" type="submit">Submit</button>
      </form>
    </div>
    <%}else{%>
    <div class="card mb-3 userReview">
      <div class="card-body">
        <h5 class="card-title"><%=userReview[0].author.username%></h5>
        <p class="starability-result" data-rating="<%=userReview[0].rating%>">
          Rated: <%=userReview[0].rating%> stars
        </p>
        <p class="card-text">Review: <%=userReview[0].body%></p>
        <form
          action="/campgrounds/<%=campgroundID%>/reviews/<%=userReview[0]._id%>?_method=DELETE"
          method="post"
        >
          <button class="btn btn-sm btn-danger" type="submit">Delete</button>
          <div class="btn btn-sm btn-info btnShowRevUpdateFrom">Edit</div>
        </form>
      </div>
    </div>
    <div class="card mb-3 revUpdateFormCard hide">
      <div class="card-body">
        <form
          method="post"
          action="/campgrounds/<%=campgroundID%>/reviews/<%=userReview[0]._id%>?_method=PATCH"
          class="mb-3 needs-validation"
          novalidate
        >
          <div>
            <fieldset class="starability-basic">
              <input
                type="radio"
                id="no-rate"
                class="input-no-rate"
                name="review[rating]"
                aria-label="No rating."
              />
              <%for(let j = 1; j<=5; j++ ){%> <input type="radio"
              id="first-rate<%=j%>" name="review[rating]" value="<%=j%>"
              <%=userReview[0].rating == j?"checked" : ""%> />
              <label for="first-rate<%=j%>" title="<%=starDesc[j]-1%>"
                ><%=j%> star</label
              >
              <%}%>

              <!-- <input
                type="radio"
                id="first-rate1"
                name="review[rating]"
                value="1"
              />
              <label for="first-rate1" title="Terrible">1 star</label>
              <input
                type="radio"
                id="first-rate2"
                name="review[rating]"
                value="2"
              />
              <label for="first-rate2" title="Not good">2 stars</label>
              <input
                type="radio"
                id="first-rate3"
                name="review[rating]"
                value="3"
              />
              <label for="first-rate3" title="Average">3 stars</label>
              <input
                type="radio"
                id="first-rate4"
                name="review[rating]"
                value="4"
              />
              <label for="first-rate4" title="Very good">4 stars</label>
              <input
                type="radio"
                id="first-rate5"
                name="review[rating]"
                value="5"
              />
              <label for="first-rate5" title="Amazing">5 stars</label> -->
            </fieldset>
          </div>
          <div class="mb-3">
            <label for="body" class="form-label">Review Text</label>
            <textarea
              class="form-control"
              name="review[body]"
              id="body"
              rows="3"
              required
            >
<%=userReview[0].body%></textarea
            >
            <div class="valid-feedback">Looks good!</div>
          </div>
          <button class="btn btn-success" type="submit">Update</button>
          <div class="btn btn-danger btnCancelRevUpdateFrom">Cancel</div>
        </form>
      </div>
    </div>
    <%}%> <%}else{%>
    <div class="mb-4">
      <a href="/login" class="btn btn-success btn-lg">Leave a review</a>
    </div>
    <%}%> <%for(let review of reviews){%>
    <div class="card mb-3">
      <div class="card-body">
        <h5 class="card-title"><%=review.author.username%></h5>
        <p class="starability-result" data-rating="<%=review.rating%>">
          Rated: <%=review.rating%> stars
        </p>
        <p class="card-text">Review: <%=review.body%></p>
      </div>
    </div>
    <%}%>
  </div>
</div>
<script>
  const btnShowRevUpdateFrom = document.querySelector(".btnShowRevUpdateFrom");
  const btnCancelRevUpdateFrom = document.querySelector(
    ".btnCancelRevUpdateFrom"
  );
  const revUpdateFormCard = document.querySelector(".revUpdateFormCard");
  const userReview = document.querySelector(".userReview");
  if (btnShowRevUpdateFrom) {
    btnShowRevUpdateFrom.addEventListener("click", () => {
      revUpdateFormCard.classList.remove("hide");
      userReview.classList.add("hide");
    });
  }
  if (btnCancelRevUpdateFrom) {
    btnCancelRevUpdateFrom.addEventListener("click", () => {
      revUpdateFormCard.classList.add("hide");
      userReview.classList.remove("hide");
    });
  }
</script>
